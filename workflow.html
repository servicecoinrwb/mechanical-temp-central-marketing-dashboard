<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Business Workflow</title>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebase/9.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebase/9.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebase/9.1.0/firebase-firestore.js";
        
        // --- Your Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyAd3taUTwf9AJv6M7RMvCWKlgw_pdqrRpM",
          authDomain: "weekly-workflow-478915.firebaseapp.com",
          projectId: "weekly-workflow-478915",
          storageBucket: "weekly-workflow-478915.firebasestorage.app",
          messagingSenderId: "1035427962286",
          appId: "1:1035427962286:web:2e23291d8926bed94f3c3f",
          measurementId: "G-8SRKJDSDX3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Initialize Auth
        const db = getFirestore(app); // Initialize Firestore
        
        // Expose Firebase objects globally for existing script to use (since we're using type="module")
        window.auth = auth;
        window.db = db;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;

    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .checkbox-wrapper input:checked + div {
            background-color: #10b981;
            border-color: #10b981;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }
        .task-text { transition: all 0.2s; }
        .task-done .task-text {
            text-decoration: line-through;
            color: #9ca3af;
        }
        /* Edit mode styles */
        .delete-btn { display: none; }
        .edit-mode .delete-btn { display: block; }
        .edit-mode .checkbox-wrapper { display: none; }
        .edit-mode .drag-handle { display: block; cursor: move; }
        .add-btn { display: none; }
        .edit-mode .add-btn { display: flex; }
        
        /* Smooth fade for progress bar */
        .progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Weekly Workflow</h1>
                    <p class="text-sm text-gray-500" id="date-display">Current Week</p>
                </div>
                
                <div class="flex items-center gap-3">
                    <button onclick="toggleEditMode()" id="edit-btn" class="px-4 py-2 rounded-lg text-sm font-medium border border-gray-300 hover:bg-gray-50 text-gray-700 transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-pen-to-square"></i> <span id="edit-text">Edit Tasks</span>
                    </button>
                    <button onclick="resetWeek()" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 hover:bg-blue-700 text-white shadow-sm transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-rotate-right"></i> Start New Week
                    </button>
                </div>
            </div>
            
            <div class="mt-4 w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                <div id="progress-fill" class="bg-green-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-400 mt-1">
                <span>Progress</span>
                <span id="progress-text">0%</span>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 sm:p-6 lg:p-8">
        <div id="grid-container" class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <p id="loading-text" class="text-center text-gray-500 col-span-full">Connecting to Firebase...</p>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-7xl mx-auto py-6 px-4 text-center text-gray-500 text-sm">
            <p>Data is now saved automatically to **Cloud Firestore**.</p>
        </div>
    </footer>

    <dialog id="add-modal" class="p-0 rounded-lg shadow-xl backdrop:bg-gray-900/50 w-full max-w-md">
        <div class="bg-white p-6">
            <h3 class="text-lg font-semibold mb-4">Add New Task</h3>
            <input type="text" id="new-task-input" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., Call accountant">
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md">Cancel</button>
                <button onclick="confirmAddTask()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Task</button>
            </div>
        </div>
    </dialog>

    <script>
        // Default Data Structure (Used only for first-time database population)
        const defaultData = [
            {
                day: "Weekend Prep",
                color: "indigo",
                tasks: [
                    { text: "Set up 20 posts on Buffer", done: false },
                    { text: "Set up 5 posts on X", done: false }
                ]
            },
            {
                day: "Monday",
                color: "blue",
                subtext: "AM: Check Marketing Mgmt",
                tasks: [
                    { text: "Check Marketing Management (AM)", done: false },
                    { text: "Finish quotes from last week", done: false },
                    { text: "Nextdoor post", done: false },
                    { text: "Field work (Rest of day)", done: false },
                    { text: "Balance bookkeeping", done: false }
                ]
            },
            {
                day: "Tuesday",
                color: "blue",
                subtext: "AM: Check Marketing (1hr)",
                tasks: [
                    { text: "Check Marketing Mgmt (1 hr)", done: false },
                    { text: "Draft new blog post for Friday", done: false },
                    { text: "Field work", done: false }
                ]
            },
            {
                day: "Wednesday",
                color: "blue",
                subtext: "AM: Check Marketing & Finance",
                tasks: [
                    { text: "Check Marketing Management", done: false },
                    { text: "Check over financials", done: false },
                    { text: "Nextdoor post", done: false },
                    { text: "Field work", done: false },
                    { text: "Balance bookkeeping", done: false }
                ]
            },
            {
                day: "Thursday",
                color: "blue",
                subtext: "AM: Check Marketing",
                tasks: [
                    { text: "Check Marketing Management", done: false },
                    { text: "Finish any open quotes", done: false },
                    { text: "Field work", done: false }
                ]
            },
            {
                day: "Friday",
                color: "purple",
                subtext: "Payroll & Wrap-up",
                tasks: [
                    { text: "Process Payroll", done: false },
                    { text: "Check Marketing Management", done: false },
                    { text: "Nextdoor post", done: false },
                    { text: "Release blog post & update page", done: false },
                    { text: "Balance bookkeeping", done: false }
                ]
            }
        ];

        // State
        let workflowData = []; 
        let isEditMode = false;
        let currentDayIndexForAdd = null;
        let currentUserId = null; 
        const DB_COLLECTION = "workflows"; 
        const DB_DOCUMENT = "master_workflow_data"; 

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Start the authentication and data loading process
            signInUser();
            updateDate();
        });

        // --- FIREBASE AUTH & DB LISTENERS ---

        function signInUser() {
            // Use the globally available auth object from the module script
            window.signInAnonymously(window.auth)
                .then(() => {
                    window.onAuthStateChanged(window.auth, (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            listenToWorkflowData();
                        }
                    });
                })
                .catch((error) => {
                    console.error("Anonymous sign-in failed:", error.message);
                    document.getElementById('loading-text').textContent = 'Error: Could not connect to database. Check Firebase configuration and rules.';
                });
        }

        function listenToWorkflowData() {
            // Reference to the master document
            const docRef = window.doc(window.db, DB_COLLECTION, DB_DOCUMENT);

            // Set up real-time listener
            window.onSnapshot(docRef, (docSnap) => {
                const loadingText = document.getElementById('loading-text');
                if (docSnap.exists()) {
                    // Data exists, load it
                    workflowData = docSnap.data().data;
                    if (loadingText) loadingText.remove(); // Remove loading text once data is here
                    render();
                } else {
                    // No data for this document, save the default structure
                    if (!workflowData.length) { // Only set defaults if state is empty
                        workflowData = defaultData;
                        save(); // Save the default data to Firestore
                    }
                }
            }, (error) => {
                console.error("Error listening to database:", error);
                document.getElementById('loading-text').textContent = 'Error loading data: ' + error.code;
            });
        }

        // --- MODIFIED SAVE FUNCTION ---
        function save() {
            if (!currentUserId) {
                console.error("User not authenticated. Cannot save.");
                return;
            }
            
            const docRef = window.doc(window.db, DB_COLLECTION, DB_DOCUMENT);
            // Overwrite the document with the new data array inside an object
            window.setDoc(docRef, { data: workflowData })
                .catch((error) => {
                    console.error("Error writing document: ", error);
                });
            // render() is called automatically by the real-time listener (onSnapshot)
        }

        // --- CORE UI/DATA LOGIC (Calls save() instead of localStorage) ---

        function updateDate() {
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            const today = new Date();
            document.getElementById('date-display').textContent = today.toLocaleDateString('en-US', options);
        }

        function getIcon(text) {
            const t = text.toLowerCase();
            if (t.includes('buffer') || t.includes('x') || t.includes('post') || t.includes('nextdoor')) return 'fa-share-nodes';
            if (t.includes('marketing')) return 'fa-bullhorn';
            if (t.includes('quote')) return 'fa-file-invoice-dollar';
            if (t.includes('field')) return 'fa-tractor';
            if (t.includes('bookkeeping') || t.includes('financial')) return 'fa-calculator';
            if (t.includes('payroll')) return 'fa-money-bill-wave';
            if (t.includes('blog')) return 'fa-pen-nib';
            return 'fa-check';
        }

        function updateProgress() {
            let total = 0;
            let completed = 0;
            workflowData.forEach(day => {
                day.tasks.forEach(task => {
                    total++;
                    if (task.done) completed++;
                });
            });
            
            const percent = total === 0 ? 0 : Math.round((completed / total) * 100);
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = `${percent}% Complete`;
        }

        function toggleTask(dayIndex, taskIndex) {
            if (isEditMode) return;
            workflowData[dayIndex].tasks[taskIndex].done = !workflowData[dayIndex].tasks[taskIndex].done;
            save(); // Updates Firebase
        }

        function deleteTask(dayIndex, taskIndex) {
            if (!confirm("Delete this task?")) return;
            workflowData[dayIndex].tasks.splice(taskIndex, 1);
            save(); // Updates Firebase
        }

        function openAddModal(dayIndex) {
            currentDayIndexForAdd = dayIndex;
            const modal = document.getElementById('add-modal');
            document.getElementById('new-task-input').value = '';
            modal.showModal();
            document.getElementById('new-task-input').focus();
        }

        function closeModal() {
            document.getElementById('add-modal').close();
        }

        function confirmAddTask() {
            const input = document.getElementById('new-task-input');
            const text = input.value.trim();
            if (text && currentDayIndexForAdd !== null) {
                workflowData[currentDayIndexForAdd].tasks.push({ text: text, done: false });
                save(); // Updates Firebase
                closeModal();
            }
        }

        function updateTaskText(dayIndex, taskIndex, newText) {
            workflowData[dayIndex].tasks[taskIndex].text = newText;
            save(); // Updates Firebase
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const body = document.body;
            const btnText = document.getElementById('edit-text');
            const btn = document.getElementById('edit-btn');
            
            if (isEditMode) {
                body.classList.add('edit-mode');
                btnText.textContent = "Done Editing";
                btn.classList.add('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
                btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
            } else {
                body.classList.remove('edit-mode');
                btnText.textContent = "Edit Tasks";
                btn.classList.remove('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
                btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
            }
            render();
        }

        function resetWeek() {
            if(confirm("Are you sure you want to start a new week? This will uncheck all tasks and update the shared database.")) {
                workflowData.forEach(day => {
                    day.tasks.forEach(task => {
                        task.done = false;
                    });
                });
                save(); // Updates Firebase
            }
        }

        function render() {
            const container = document.getElementById('grid-container');
            
            // Do not clear the container if the loading text is present and data isn't loaded yet
            if (workflowData.length === 0 && !document.getElementById('loading-text')) {
                container.innerHTML = '<p id="loading-text" class="text-center text-gray-500 col-span-full">Loading workflow data...</p>';
                return;
            } else if (workflowData.length > 0) {
                 // Clear the grid only when we have data to render
                container.innerHTML = ''; 
            }

            workflowData.forEach((dayData, dayIndex) => {
                // Calculate daily progress
                const dayTotal = dayData.tasks.length;
                const dayDone = dayData.tasks.filter(t => t.done).length;
                const dayProgress = dayTotal === 0 ? 0 : (dayDone / dayTotal) * 100;
                const isComplete = dayTotal > 0 && dayDone === dayTotal;

                const card = document.createElement('div');
                card.className = `bg-white rounded-xl shadow-sm border ${isComplete ? 'border-green-200 bg-green-50' : 'border-gray-200'} overflow-hidden flex flex-col transition-all duration-300 hover:shadow-md`;

                // Card Header
                const header = document.createElement('div');
                header.className = `p-4 border-b ${isComplete ? 'border-green-100' : 'border-gray-100'} bg-opacity-50 ${dayData.color === 'indigo' ? 'bg-indigo-50' : dayData.color === 'purple' ? 'bg-purple-50' : 'bg-blue-50'}`;
                header.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="font-bold text-lg text-gray-800">${dayData.day}</h2>
                            ${dayData.subtext ? `<p class="text-xs text-gray-500 mt-1">${dayData.subtext}</p>` : ''}
                        </div>
                        ${isComplete ? '<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold">DONE</span>' : ''}
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1 mt-3">
                        <div class="bg-${dayData.color}-500 h-1 rounded-full transition-all duration-500" style="width: ${dayProgress}%"></div>
                    </div>
                `;
                card.appendChild(header);

                // Task List
                const list = document.createElement('div');
                list.className = 'p-4 flex-grow space-y-3';

                dayData.tasks.forEach((task, taskIndex) => {
                    const item = document.createElement('div');
                    item.className = `flex items-center gap-3 group ${task.done ? 'task-done' : ''}`;
                    
                    const iconClass = getIcon(task.text);

                    // View Mode HTML
                    const viewHTML = `
                        <label class="checkbox-wrapper relative flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only" ${task.done ? 'checked' : ''} onchange="toggleTask(${dayIndex}, ${taskIndex})">
                            <div class="w-5 h-5 border-2 border-gray-300 rounded bg-white flex items-center justify-center transition-colors hover:border-${dayData.color}-400">
                                <svg class="w-3 h-3 text-white hidden fill-current" viewBox="0 0 20 20"><path d="M0 11l2-2 5 5L18 3l2 2L7 18z"/></svg>
                            </div>
                        </label>
                        <i class="fa-solid ${iconClass} text-gray-400 text-xs w-4 text-center ${isEditMode ? 'hidden' : ''}"></i>
                        <span class="task-text text-sm text-gray-700 select-none flex-grow cursor-pointer" onclick="toggleTask(${dayIndex}, ${taskIndex})">${task.text}</span>
                    `;

                    // Edit Mode HTML
                    const editHTML = `
                        <button onclick="deleteTask(${dayIndex}, ${taskIndex})" class="delete-btn text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition-colors">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <input type="text" 
                            value="${task.text}" 
                            onchange="updateTaskText(${dayIndex}, ${taskIndex}, this.value)"
                            class="flex-grow text-sm border border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    `;

                    item.innerHTML = isEditMode ? editHTML : viewHTML;
                    list.appendChild(item);
                });

                // Add Button (Only in Edit Mode)
                const addBtn = document.createElement('button');
                addBtn.className = 'add-btn w-full mt-2 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 text-sm hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-all items-center justify-center gap-2';
                addBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Add Task';
                addBtn.onclick = () => openAddModal(dayIndex);
                list.appendChild(addBtn);

                card.appendChild(list);
                container.appendChild(card);
            });
            
            updateProgress();
        }
    </script>
</body>
</html>
