<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Business Workflow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .checkbox-wrapper input:checked + div {
            background-color: #10b981;
            border-color: #10b981;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }
        .task-text { transition: all 0.2s; }
        .task-done .task-text {
            text-decoration: line-through;
            color: #9ca3af;
        }
        /* Edit mode styles */
        .delete-btn { display: none; }
        .edit-mode .delete-btn { display: block; }
        .edit-mode .checkbox-wrapper { display: none; }
        .edit-mode .drag-handle { display: block; cursor: move; }
        .add-btn { display: none; }
        .edit-mode .add-btn { display: flex; }
        
        /* Smooth fade for progress bar */
        .progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Weekly Workflow</h1>
                    <p class="text-sm text-gray-500" id="date-display">Current Week</p>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- Auth Buttons -->
                    <button id="google-signin-btn" class="hidden px-4 py-2 rounded-lg text-sm font-medium bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 shadow-sm transition-colors flex items-center gap-2">
                        <i class="fa-brands fa-google text-red-500"></i> Sign In
                    </button>
                    
                    <div id="user-profile" class="hidden items-center gap-3 bg-gray-100 px-3 py-1.5 rounded-lg">
                        <div class="w-6 h-6 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold" id="user-avatar">U</div>
                        <span class="text-xs font-medium text-gray-600" id="user-email">user@email.com</span>
                        <button id="signout-btn" class="text-xs text-red-500 hover:text-red-700 ml-2 font-semibold">Sign Out</button>
                    </div>

                    <button id="edit-btn" class="px-4 py-2 rounded-lg text-sm font-medium border border-gray-300 hover:bg-gray-50 text-gray-700 transition-colors flex items-center gap-2" disabled>
                        <i class="fa-solid fa-pen-to-square"></i> <span id="edit-text">Edit Tasks</span>
                    </button>
                    <button id="reset-btn" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 hover:bg-blue-700 text-white shadow-sm transition-colors flex items-center gap-2" disabled>
                        <i class="fa-solid fa-rotate-right"></i> Start New Week
                    </button>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-4 w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                <div id="progress-fill" class="bg-green-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-400 mt-1">
                <span>Progress</span>
                <span id="progress-text">0%</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 sm:p-6 lg:p-8">
        <div id="grid-container" class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <p id="loading-text" class="text-center text-gray-500 col-span-full">Initializing secure connection...</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-7xl mx-auto py-6 px-4 text-center text-gray-500 text-sm">
            <p>Data is saved automatically to <span class="font-semibold text-blue-600">Cloud Firestore</span>.</p>
        </div>
    </footer>

    <!-- Edit Modal -->
    <dialog id="add-modal" class="p-0 rounded-lg shadow-xl backdrop:bg-gray-900/50 w-full max-w-md">
        <div class="bg-white p-6">
            <h3 class="text-lg font-semibold mb-4">Add New Task</h3>
            <input type="text" id="new-task-input" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., Call accountant">
            <div class="flex justify-end gap-3 mt-6">
                <button id="modal-cancel-btn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md">Cancel</button>
                <button id="modal-add-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Task</button>
            </div>
        </div>
    </dialog>

    <!-- Firebase & App Logic -->
    <script type="module">
        // Using CDN imports compatible with standalone HTML files
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        // UPDATED: Using your exact provided configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAd3taUTwf9AJv6M7RMvCWKlgw_pdqrRpM",
            authDomain: "weekly-workflow-478915.firebaseapp.com", 
            projectId: "weekly-workflow-478915",
            storageBucket: "weekly-workflow-478915.firebasestorage.app",
            messagingSenderId: "1035427962286",
            appId: "1:1035427962286:web:2e23291d8926bed94f3c3f",
            measurementId: "G-8SRKJDSDX3"
        };
        
        // Use the Project ID as the App ID for data storage consistency
        const appId = "weekly-workflow-478915";
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // --- State Management ---
        let workflowData = [];
        let isEditMode = false;
        let currentUserId = null;
        let unsubscribeData = null; // Listener cleanup function
        let currentDayIndexForAdd = null;

        // --- Default Data ---
        const defaultData = [
            { day: "Weekend Prep", color: "indigo", tasks: [{ text: "Set up 20 posts on Buffer", done: false }, { text: "Set up 5 posts on X", done: false }] },
            { day: "Monday", color: "blue", subtext: "AM: Check Marketing Mgmt", tasks: [{ text: "Check Marketing Management (AM)", done: false }, { text: "Finish quotes from last week", done: false }, { text: "Nextdoor post", done: false }, { text: "Field work (Rest of day)", done: false }, { text: "Balance bookkeeping", done: false }] },
            { day: "Tuesday", color: "blue", subtext: "AM: Check Marketing (1hr)", tasks: [{ text: "Check Marketing Mgmt (1 hr)", done: false }, { text: "Draft new blog post for Friday", done: false }, { text: "Field work", done: false }] },
            { day: "Wednesday", color: "blue", subtext: "AM: Check Marketing & Finance", tasks: [{ text: "Check Marketing Management", done: false }, { text: "Check over financials", done: false }, { text: "Nextdoor post", done: false }, { text: "Field work", done: false }, { text: "Balance bookkeeping", done: false }] },
            { day: "Thursday", color: "blue", subtext: "AM: Check Marketing", tasks: [{ text: "Check Marketing Management", done: false }, { text: "Finish any open quotes", done: false }, { text: "Field work", done: false }] },
            { day: "Friday", color: "purple", subtext: "Payroll & Wrap-up", tasks: [{ text: "Process Payroll", done: false }, { text: "Check Marketing Management", done: false }, { text: "Nextdoor post", done: false }, { text: "Release blog post & update page", done: false }, { text: "Balance bookkeeping", done: false }] }
        ];

        // --- Authentication UI Logic ---
        const signInBtn = document.getElementById('google-signin-btn');
        const userProfile = document.getElementById('user-profile');
        const userEmailSpan = document.getElementById('user-email');
        const userAvatar = document.getElementById('user-avatar');
        const signOutBtn = document.getElementById('signout-btn');

        // Handle Google Sign In
        signInBtn.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, googleProvider);
            } catch (error) {
                console.error("Error signing in:", error);
                alert("Sign in failed. Check console.");
            }
        });

        // Handle Sign Out
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // On signout, we might want to signInAnonymously again to keep app usable
                // or just let the auth state listener handle it (it will go to null, then we can trigger anon)
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Error signing out:", error);
            }
        });

        // Listen for Auth State
        onAuthStateChanged(auth, (user) => {
            const editBtn = document.getElementById('edit-btn');
            const resetBtn = document.getElementById('reset-btn');

            if (user) {
                currentUserId = user.uid;
                
                // Update UI based on whether user is Anonymous or Google
                if (user.isAnonymous) {
                    // Show Sign In Button, Hide Profile
                    signInBtn.classList.remove('hidden');
                    userProfile.classList.add('hidden');
                } else {
                    // Hide Sign In Button, Show Profile
                    signInBtn.classList.add('hidden');
                    userProfile.classList.remove('hidden');
                    userProfile.classList.add('flex');
                    userEmailSpan.textContent = user.email || "User";
                    userAvatar.textContent = (user.email || "U")[0].toUpperCase();
                }

                editBtn.disabled = false;
                resetBtn.disabled = false;
                
                // Load data immediately after auth
                setupDataListener(user.uid);
            } else {
                // If no user at all, try anonymous login to at least show the app
                signInAnonymously(auth).catch(console.error);
            }
        });

        // --- Database Logic (Firestore) ---
        function setupDataListener(userId) {
            if (!userId) return;

            // Stop listening to previous user's data if any
            if (unsubscribeData) {
                unsubscribeData();
            }

            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'workflow');

            unsubscribeData = onSnapshot(docRef, (docSnap) => {
                const loadingText = document.getElementById('loading-text');
                if (loadingText) loadingText.remove();

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    workflowData = data.items || defaultData;
                } else {
                    workflowData = defaultData;
                    // Optional: Don't auto-save immediately on read-miss to avoid cluttering DB with anon users
                    // But helpful for UX
                }
                render();
            }, (error) => {
                console.error("Data fetch error:", error);
                const container = document.getElementById('grid-container');
                container.innerHTML = '<p class="text-red-500 text-center col-span-full">Error syncing data. Please refresh.</p>';
            });
        }

        async function saveData() {
            if (!currentUserId) return;
            
            const docRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'data', 'workflow');
            try {
                await setDoc(docRef, { items: workflowData });
                updateProgress();
            } catch (e) {
                console.error("Save failed:", e);
            }
        }

        // --- UI Logic ---
        
        window.toggleTask = (dayIndex, taskIndex) => {
            if (isEditMode) return;
            workflowData[dayIndex].tasks[taskIndex].done = !workflowData[dayIndex].tasks[taskIndex].done;
            saveData(); 
            render();   
        };

        window.deleteTask = (dayIndex, taskIndex) => {
            if (!confirm("Delete this task?")) return;
            workflowData[dayIndex].tasks.splice(taskIndex, 1);
            saveData();
            render();
        };

        window.updateTaskText = (dayIndex, taskIndex, newText) => {
            workflowData[dayIndex].tasks[taskIndex].text = newText;
            saveData();
        };

        // Edit Mode Toggle
        const editBtn = document.getElementById('edit-btn');
        editBtn.addEventListener('click', () => {
            isEditMode = !isEditMode;
            const body = document.body;
            const btnText = document.getElementById('edit-text');
            
            if (isEditMode) {
                body.classList.add('edit-mode');
                btnText.textContent = "Done Editing";
                editBtn.classList.add('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
                editBtn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
            } else {
                body.classList.remove('edit-mode');
                btnText.textContent = "Edit Tasks";
                editBtn.classList.remove('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
                editBtn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
            }
            render();
        });

        // Reset Week
        const resetBtn = document.getElementById('reset-btn');
        resetBtn.addEventListener('click', () => {
            if(confirm("Start a new week? This will uncheck all tasks.")) {
                workflowData.forEach(day => {
                    day.tasks.forEach(task => task.done = false);
                });
                saveData();
                render();
            }
        });

        // --- Modal Logic ---
        window.openAddModal = (dayIndex) => {
            currentDayIndexForAdd = dayIndex;
            const modal = document.getElementById('add-modal');
            document.getElementById('new-task-input').value = '';
            modal.showModal();
            document.getElementById('new-task-input').focus();
        };

        document.getElementById('modal-cancel-btn').addEventListener('click', () => {
            document.getElementById('add-modal').close();
        });

        document.getElementById('modal-add-btn').addEventListener('click', () => {
            const input = document.getElementById('new-task-input');
            const text = input.value.trim();
            if (text && currentDayIndexForAdd !== null) {
                workflowData[currentDayIndexForAdd].tasks.push({ text: text, done: false });
                saveData();
                render();
                document.getElementById('add-modal').close();
            }
        });

        // --- Helpers ---
        function updateDate() {
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            document.getElementById('date-display').textContent = new Date().toLocaleDateString('en-US', options);
        }
        updateDate();

        function getIcon(text) {
            const t = text.toLowerCase();
            if (t.includes('buffer') || t.includes('x') || t.includes('post') || t.includes('nextdoor')) return 'fa-share-nodes';
            if (t.includes('marketing')) return 'fa-bullhorn';
            if (t.includes('quote')) return 'fa-file-invoice-dollar';
            if (t.includes('field')) return 'fa-tractor';
            if (t.includes('bookkeeping') || t.includes('financial')) return 'fa-calculator';
            if (t.includes('payroll')) return 'fa-money-bill-wave';
            if (t.includes('blog')) return 'fa-pen-nib';
            return 'fa-check';
        }

        function updateProgress() {
            let total = 0;
            let completed = 0;
            if(workflowData) {
                workflowData.forEach(day => {
                    day.tasks.forEach(task => {
                        total++;
                        if (task.done) completed++;
                    });
                });
            }
            const percent = total === 0 ? 0 : Math.round((completed / total) * 100);
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = `${percent}% Complete`;
        }

        function render() {
            const container = document.getElementById('grid-container');
            
            if (!workflowData || workflowData.length === 0) {
                return; 
            } 
            
            container.innerHTML = ''; 

            workflowData.forEach((dayData, dayIndex) => {
                const dayTotal = dayData.tasks.length;
                const dayDone = dayData.tasks.filter(t => t.done).length;
                const dayProgress = dayTotal === 0 ? 0 : (dayDone / dayTotal) * 100;
                const isComplete = dayTotal > 0 && dayDone === dayTotal;

                const card = document.createElement('div');
                card.className = `bg-white rounded-xl shadow-sm border ${isComplete ? 'border-green-200 bg-green-50' : 'border-gray-200'} overflow-hidden flex flex-col transition-all duration-300 hover:shadow-md`;

                const header = document.createElement('div');
                header.className = `p-4 border-b ${isComplete ? 'border-green-100' : 'border-gray-100'} bg-opacity-50 ${dayData.color === 'indigo' ? 'bg-indigo-50' : dayData.color === 'purple' ? 'bg-purple-50' : 'bg-blue-50'}`;
                header.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="font-bold text-lg text-gray-800">${dayData.day}</h2>
                            ${dayData.subtext ? `<p class="text-xs text-gray-500 mt-1">${dayData.subtext}</p>` : ''}
                        </div>
                        ${isComplete ? '<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold">DONE</span>' : ''}
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1 mt-3">
                        <div class="bg-${dayData.color}-500 h-1 rounded-full transition-all duration-500" style="width: ${dayProgress}%"></div>
                    </div>
                `;
                card.appendChild(header);

                const list = document.createElement('div');
                list.className = 'p-4 flex-grow space-y-3';

                dayData.tasks.forEach((task, taskIndex) => {
                    const item = document.createElement('div');
                    item.className = `flex items-center gap-3 group ${task.done ? 'task-done' : ''}`;
                    
                    const iconClass = getIcon(task.text);

                    const viewHTML = `
                        <label class="checkbox-wrapper relative flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only" ${task.done ? 'checked' : ''} onchange="toggleTask(${dayIndex}, ${taskIndex})">
                            <div class="w-5 h-5 border-2 border-gray-300 rounded bg-white flex items-center justify-center transition-colors hover:border-${dayData.color}-400">
                                <svg class="w-3 h-3 text-white hidden fill-current" viewBox="0 0 20 20"><path d="M0 11l2-2 5 5L18 3l2 2L7 18z"/></svg>
                            </div>
                        </label>
                        <i class="fa-solid ${iconClass} text-gray-400 text-xs w-4 text-center ${isEditMode ? 'hidden' : ''}"></i>
                        <span class="task-text text-sm text-gray-700 select-none flex-grow cursor-pointer" onclick="toggleTask(${dayIndex}, ${taskIndex})">${task.text}</span>
                    `;

                    const editHTML = `
                        <button onclick="deleteTask(${dayIndex}, ${taskIndex})" class="delete-btn text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition-colors">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <input type="text" 
                            value="${task.text}" 
                            onchange="updateTaskText(${dayIndex}, ${taskIndex}, this.value)"
                            class="flex-grow text-sm border border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    `;

                    item.innerHTML = isEditMode ? editHTML : viewHTML;
                    list.appendChild(item);
                });

                const addBtn = document.createElement('button');
                addBtn.className = 'add-btn w-full mt-2 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 text-sm hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-all items-center justify-center gap-2';
                addBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Add Task';
                addBtn.onclick = () => openAddModal(dayIndex);
                list.appendChild(addBtn);

                card.appendChild(list);
                container.appendChild(card);
            });
            
            updateProgress();
        }
    </script>
</body>
</html>
